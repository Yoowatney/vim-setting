# ============================================
# 1. Instant Prompt (p10k)
# ============================================
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# ============================================
# 2. Oh-My-Zsh 설정
# ============================================
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="powerlevel10k/powerlevel10k"

plugins=(
	zsh-completions
	zsh-syntax-highlighting
	zsh-autosuggestions
	fzf
	git
	docker
	docker-compose
)

autoload -U compinit && compinit
set -o vi
source $ZSH/oh-my-zsh.sh

# ============================================
# 3. Environment Variables
# ============================================
export LANG=en_US.UTF-8
export EDITOR=/opt/homebrew/bin/nvim
export TERM=screen-256color
export FZF_DEFAULT_OPTS="--extended"
export NVM_DIR="$HOME/.nvm"
# export MANPATH="`manpath`:/opt/homebrew/opt/readline/share/man:/opt/homebrew/opt/tmux/share/man:/opt/homebrew/opt/pass/share/man"

# ============================================
# 4. PATH 설정
# ============================================
export PATH=/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/Apple/usr/bin
export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

# ============================================
# 5. Aliases
# ============================================
# System
alias rm="trash"
alias ls="lsd"
alias lt="lsd --tree -I node_modules"
alias diff="delta"
alias tree="broot"

# Editor
alias vim="nvim"
alias vi="nvim"
alias v="nvim"
alias vimdiff="nvim -d"
alias vd="nvim -d"

# Git
alias gs="git status"
alias gl="git log --graph --oneline --all --decorate"
alias g="lazygit"

# Dev tools
alias tf="terraform"
alias ctags="`brew --prefix`/bin/ctags"
alias ccc="c++ -Wall -Wextra -Werror -std=c++98"

# Utilities
alias ss='pngpaste ~/Desktop/ss-$(date +%s).png && ls -t ~/Desktop/ss-*.png | head -1 | tr -d "\n" | pbcopy && pbpaste'
alias ql='qlmanage -p'

# ============================================
# 6. Functions
# ============================================
killport() {
    lsof -i TCP:$1 | grep LISTEN | awk '{print $2}' | xargs kill -9
}

watch() {
    while true; do clear; date; sleep 1; done
}

clam() {
    cd ~/Claude-Code-Usage-Monitor && source .venv/bin/activate && claude-monitor
} # currently not use


lleak() {
    while true; do leaks $1; sleep 1; clear; done
} # currently not use

# ============================================
# 7. Tool Initializations
# ============================================
# p10k
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# iTerm2 shell integration
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

# broot
source "$HOME/.config/broot/launcher/bash/br"

# fzf
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
bindkey "ç" fzf-cd-widget

# nvm
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && . "/opt/homebrew/opt/nvm/nvm.sh"
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && . "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"

# mise (asdf replacement)
eval "$(mise activate zsh)"

# zoxide
eval "$(zoxide init zsh)"

# Rust/Cargo
. "$HOME/.local/bin/env"

# ============================================
# 8. Completions
# ============================================
autoload -U +X bashcompinit && bashcompinit
source <(kubectl completion zsh)
complete -o nospace -C /opt/homebrew/bin/terraform terraform

# ============================================
# 9. History 설정
# ============================================
setopt APPEND_HISTORY
setopt SHARE_HISTORY
setopt HIST_IGNORE_ALL_DUPS

# ============================================
# 10. Cleanup
# ============================================
unset CPPFLAGS
unset LDFLAGS
