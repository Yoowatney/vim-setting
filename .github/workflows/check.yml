name: Check dotfiles

on:
  push:
    branches: [main]
    paths:
      - 'Brewfile'
      - '.github/workflows/check.yml'
  pull_request:
    paths:
      - 'Brewfile'
  schedule:
    # 매주 월요일 09:00 KST (00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  brewfile-check:
    name: Brewfile Validation
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Validate and setup taps
        run: |
          echo "## Tap Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          has_error=false

          # tap을 실제로 시도해서 검증
          for tap in $(grep "^tap " Brewfile | sed 's/tap "\([^"]*\)".*/\1/'); do
            if brew tap "$tap" 2>/dev/null; then
              echo "✅ $tap"
              echo "- :white_check_mark: \`$tap\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "::error::Tap '$tap' does not exist or failed to tap"
              echo "- :x: \`$tap\` - does not exist" >> $GITHUB_STEP_SUMMARY
              has_error=true
            fi
          done

          if [ "$has_error" = true ]; then
            exit 1
          fi

      - name: Validate formulae exist
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Formula Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          has_error=false

          for formula in $(grep "^brew " Brewfile | sed 's/brew "\([^"]*\)".*/\1/'); do
            if brew info "$formula" &>/dev/null; then
              echo "✅ $formula"
            else
              echo "::error::Formula '$formula' does not exist"
              echo "- :x: \`$formula\` - not found" >> $GITHUB_STEP_SUMMARY
              has_error=true
            fi
          done

          if [ "$has_error" = true ]; then
            exit 1
          fi
          echo ":white_check_mark: All formulae valid" >> $GITHUB_STEP_SUMMARY

      - name: Validate casks exist
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cask Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          has_error=false

          for cask in $(grep "^cask " Brewfile | sed 's/cask "\([^"]*\)".*/\1/'); do
            if brew info --cask "$cask" &>/dev/null; then
              echo "✅ $cask"
            else
              echo "::error::Cask '$cask' does not exist"
              echo "- :x: \`$cask\` - not found" >> $GITHUB_STEP_SUMMARY
              has_error=true
            fi
          done

          if [ "$has_error" = true ]; then
            exit 1
          fi
          echo ":white_check_mark: All casks valid" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### Package Count" >> $GITHUB_STEP_SUMMARY
          echo "- Taps: $(grep -c '^tap ' Brewfile || echo 0)" >> $GITHUB_STEP_SUMMARY
          echo "- Formulae: $(grep -c '^brew ' Brewfile || echo 0)" >> $GITHUB_STEP_SUMMARY
          echo "- Casks: $(grep -c '^cask ' Brewfile || echo 0)" >> $GITHUB_STEP_SUMMARY
          echo "- Mac App Store: $(grep -c '^mas ' Brewfile || echo 0)" >> $GITHUB_STEP_SUMMARY

  deprecated-check:
    name: Deprecated Packages Check
    runs-on: macos-14
    # 스케줄 실행이거나 수동 실행일 때만
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Setup taps
        run: |
          for tap in $(grep "^tap " Brewfile | sed 's/tap "\([^"]*\)".*/\1/'); do
            brew tap "$tap" 2>/dev/null || true
          done

      - name: Check for deprecated formulae
        run: |
          echo "## Deprecated Formulae Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          deprecated_found=false

          for formula in $(grep "^brew " Brewfile | sed 's/brew "\([^"]*\)".*/\1/'); do
            info=$(brew info "$formula" 2>/dev/null || true)
            if echo "$info" | grep -qi "deprecated"; then
              echo "::warning::$formula is deprecated"
              echo "- :warning: \`$formula\` is deprecated" >> $GITHUB_STEP_SUMMARY
              deprecated_found=true
            elif echo "$info" | grep -qi "disabled"; then
              echo "::error::$formula is disabled"
              echo "- :x: \`$formula\` is disabled" >> $GITHUB_STEP_SUMMARY
              deprecated_found=true
            fi
          done

          if [ "$deprecated_found" = false ]; then
            echo ":white_check_mark: No deprecated formulae found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for deprecated casks
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deprecated Casks Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          deprecated_found=false

          for cask in $(grep "^cask " Brewfile | sed 's/cask "\([^"]*\)".*/\1/'); do
            info=$(brew info --cask "$cask" 2>/dev/null || true)
            if echo "$info" | grep -qi "deprecated"; then
              echo "::warning::Cask $cask is deprecated"
              echo "- :warning: \`$cask\` is deprecated" >> $GITHUB_STEP_SUMMARY
              deprecated_found=true
            elif echo "$info" | grep -qi "discontinued"; then
              echo "::warning::Cask $cask is discontinued"
              echo "- :warning: \`$cask\` is discontinued" >> $GITHUB_STEP_SUMMARY
              deprecated_found=true
            fi
          done

          if [ "$deprecated_found" = false ]; then
            echo ":white_check_mark: No deprecated casks found" >> $GITHUB_STEP_SUMMARY
          fi
